# üîê –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

## ‚úÖ –ß—Ç–æ –±—ã–ª–æ —Å–¥–µ–ª–∞–Ω–æ

### 1. –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ –∫–æ–¥–µ

- ‚ùå –£–±—Ä–∞–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –Ω–µ—Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –ø–æ–ª—è `refreshToken` –≤ entity `Users`
- ‚ùå –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `User` –≤–º–µ—Å—Ç–æ `Users`
- ‚úÖ –¢–µ–ø–µ—Ä—å –≤—Å–µ refresh —Ç–æ–∫–µ–Ω—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ entity `Session`
- ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤—Å–µ –∏–º–ø–æ—Ä—Ç—ã –∏ —Ç–∏–ø—ã

### 2. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å HttpOnly Cookies

**–î–æ:**

- –¢–æ–∫–µ–Ω—ã –ø–µ—Ä–µ–¥–∞–≤–∞–ª–∏—Å—å –≤ —Ç–µ–ª–µ –æ—Ç–≤–µ—Ç–∞
- JWT —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏—Å–∫–∞–ª–∞ —Ç–æ–∫–µ–Ω—ã –≤ Bearer header
- –ù–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ

**–ü–æ—Å–ª–µ:**

- ‚úÖ –¢–æ–∫–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤ HttpOnly cookies
- ‚úÖ JWT —Å—Ç—Ä–∞—Ç–µ–≥–∏—è –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–æ–∫–µ–Ω—ã –∏–∑ cookies
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç XSS –∞—Ç–∞–∫ (JavaScript –Ω–µ –º–æ–∂–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ç–æ–∫–µ–Ω—ã)
- ‚úÖ –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF –∞—Ç–∞–∫ (SameSite=Strict)

### 3. –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω –º–µ—Ç–æ–¥ `logout`

```typescript
POST /auth/logout

// –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç accessToken –∏ refreshToken –∏–∑ cookies
2. –ù–∞—Ö–æ–¥–∏—Ç —Å–µ—Å—Å–∏—é –≤ –ë–î
3. –ü–æ–º–µ—á–∞–µ—Ç —Å–µ—Å—Å–∏—é –∫–∞–∫ revoked: true
4. –û—á–∏—â–∞–µ—Ç cookies –Ω–∞ –∫–ª–∏–µ–Ω—Ç–µ
```

### 4. –ü–µ—Ä–µ—Ä–∞–±–æ—Ç–∞–Ω –º–µ—Ç–æ–¥ `refreshToken`

```typescript
POST /auth/refresh

// –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:
1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç refreshToken –∏–∑ cookie (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)
2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å refresh —Ç–æ–∫–µ–Ω–∞
3. –ù–∞—Ö–æ–¥–∏—Ç —Å–µ—Å—Å–∏—é –≤ –ë–î
4. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, —á—Ç–æ —Å–µ—Å—Å–∏—è –Ω–µ –∏—Å—Ç–µ–∫–ª–∞ –∏ –Ω–µ –æ—Ç–æ–∑–≤–∞–Ω–∞
5. –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤—É—é –ø–∞—Ä—É —Ç–æ–∫–µ–Ω–æ–≤
6. –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–µ—Å—Å–∏—é –≤ –ë–î
7. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –Ω–æ–≤—ã–µ —Ç–æ–∫–µ–Ω—ã –≤ cookies
```

### 5. –£–ª—É—á—à–µ–Ω–∞ —Ä–∞–±–æ—Ç–∞ —Å Session

**register:**

- ‚úÖ –°–æ–∑–¥–∞–µ—Ç Session –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- ‚úÖ –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±–∞ —Ç–æ–∫–µ–Ω–∞ –≤ –ë–î

**login:**

- ‚úÖ –°–æ–∑–¥–∞–µ—Ç –Ω–æ–≤—É—é Session –ø—Ä–∏ –∫–∞–∂–¥–æ–º –ª–æ–≥–∏–Ω–µ
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ —Å–µ—Å—Å–∏–∏

**refreshToken:**

- ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é Session
- ‚úÖ –ü—Ä–æ–¥–ª–µ–≤–∞–µ—Ç –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ —Å–µ—Å—Å–∏–∏

**logout:**

- ‚úÖ –û—Ç–∑—ã–≤–∞–µ—Ç Session (revoked: true)
- ‚úÖ –ù–µ–≤–æ–∑–º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ç–æ–∑–≤–∞–Ω–Ω—É—é —Å–µ—Å—Å–∏—é

### 6. –ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å cookies

```typescript
// Access Token cookie
{
  httpOnly: true,           // –ù–µ–¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è JavaScript
  secure: true,             // –¢–æ–ª—å–∫–æ HTTPS –≤ production
  sameSite: 'strict',       // –ó–∞—â–∏—Ç–∞ –æ—Ç CSRF
  maxAge: 15 * 60 * 1000,  // 15 –º–∏–Ω—É—Ç
  path: '/',
}

// Refresh Token cookie
{
  httpOnly: true,
  secure: true,
  sameSite: 'strict',
  maxAge: 7 * 24 * 60 * 60 * 1000, // 7 –¥–Ω–µ–π
  path: '/',
}
```

### 7. –î–æ–±–∞–≤–ª–µ–Ω cookie-parser

```typescript
// main.ts
app.use(cookieParser());
```

### 8. –û–±–Ω–æ–≤–ª–µ–Ω—ã JWT —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏

**–î–æ:**

```typescript
jwtFromRequest: ExtractJwt.fromAuthHeaderAsBearerToken();
```

**–ü–æ—Å–ª–µ:**

```typescript
// –ö–∞—Å—Ç–æ–º–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∏–∑ cookies
const extractJwtFromCookie = (req) => {
  return req.cookies.accessToken || null;
};

jwtFromRequest: extractJwtFromCookie;
```

## üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è

–°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è:

1. **AUTH_FLOW.md** - –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≤—Å–µ–≥–æ flow –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
2. **FRONTEND_INTEGRATION.md** - –ì–æ—Ç–æ–≤—ã–µ –ø—Ä–∏–º–µ—Ä—ã –∫–æ–¥–∞ –¥–ª—è —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
3. **AUTH_CHANGES.md** - –≠—Ç–æ—Ç —Ñ–∞–π–ª —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏–π

## üöÄ –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å

### Backend –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ:

```bash
# –í—Å–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã
# cookie-parser –Ω–∞—Å—Ç—Ä–æ–µ–Ω
# –í—Å–µ –º–µ—Ç–æ–¥—ã —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã

# –ü—Ä–æ—Å—Ç–æ –∑–∞–ø—É—Å—Ç–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä:
npm run start:dev
```

### Frontend - –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä—ã –∏–∑ FRONTEND_INTEGRATION.md:

1. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ axios —Å `withCredentials: true`
2. –î–æ–±–∞–≤—å—Ç–µ interceptor –¥–ª—è –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–æ–∫–µ–Ω–æ–≤
3. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≥–æ—Ç–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è login/logout/register

## üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã

### 1. –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è

```bash
curl -X POST http://localhost:3000/auth/register \
  -H "Content-Type: application/json" \
  -d '{
    "email": "test@test.com",
    "password": "password123",
    "firstName": "Test",
    "lastName": "User",
    "organizationName": "Test Org"
  }' \
  -c cookies.txt -v
```

### 2. –ó–∞—â–∏—â–µ–Ω–Ω—ã–π –∑–∞–ø—Ä–æ—Å

```bash
curl http://localhost:3000/projects \
  -b cookies.txt
```

### 3. Refresh —Ç–æ–∫–µ–Ω–∞

```bash
curl -X POST http://localhost:3000/auth/refresh \
  -b cookies.txt \
  -c cookies.txt
```

### 4. Logout

```bash
curl -X POST http://localhost:3000/auth/logout \
  -b cookies.txt
```

## ‚ö†Ô∏è –í–∞–∂–Ω–æ –¥–ª—è Production

1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:

```env
JWT_SECRET=your-super-secret-key-here
JWT_REFRESH_SECRET=your-super-secret-refresh-key-here
NODE_ENV=production
FRONTEND_URL=https://yourdomain.com
```

2. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS –¥–ª—è Secure cookies

3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π CORS –¥–ª—è –≤–∞—à–µ–≥–æ –¥–æ–º–µ–Ω–∞

## üéØ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º—ã

1. ‚úÖ **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å**: HttpOnly cookies –∑–∞—â–∏—â–∞—é—Ç –æ—Ç XSS
2. ‚úÖ **–ü—Ä–æ—Å—Ç–æ—Ç–∞**: –§—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ —É–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–æ–∫–µ–Ω–∞–º–∏ –≤—Ä—É—á–Ω—É—é
3. ‚úÖ **–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ**: –¢–æ–∫–µ–Ω—ã –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø—Ä–æ–∑—Ä–∞—á–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
4. ‚úÖ **–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ**: –í—Å–µ —Å–µ—Å—Å–∏–∏ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ë–î
5. ‚úÖ **–û—Ç–∑—ã–≤**: –ú–æ–∂–Ω–æ –æ—Ç–æ–∑–≤–∞—Ç—å –ª—é–±—É—é —Å–µ—Å—Å–∏—é –≤ –ª—é–±–æ–π –º–æ–º–µ–Ω—Ç
6. ‚úÖ **–ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤/—Å–µ—Å—Å–∏–π

## üîß –ï—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç

### Cookies –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ `cookie-parser` –ø–æ–¥–∫–ª—é—á–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (`credentials: true`)
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Ñ—Ä–æ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `withCredentials: true`

### –¢–æ–∫–µ–Ω –Ω–µ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ refresh token –≤–∞–ª–∏–¥–µ–Ω
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ —Å–µ—Å—Å–∏—è –Ω–µ –æ—Ç–æ–∑–≤–∞–Ω–∞

### 401 –Ω–∞ –∑–∞—â–∏—â–µ–Ω–Ω—ã—Ö —Ä–æ—É—Ç–∞—Ö

- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ, —á—Ç–æ cookies –æ—Ç–ø—Ä–∞–≤–ª—è—é—Ç—Å—è —Å –∑–∞–ø—Ä–æ—Å–æ–º
- –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Ç–æ–∫–µ–Ω –Ω–µ –∏—Å—Ç–µ–∫
- –ü—Ä–æ–≤–µ—Ä—å—Ç–µ JWT_SECRET

## üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã

–ï—Å–ª–∏ –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã - –æ–±—Ä–∞—â–∞–π—Ç–µ—Å—å!
